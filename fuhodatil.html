<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>复活件明细</title>
<style>
body{margin:0;font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:8px;background:#f2f2f2;}
h3{margin:0 0 8px;text-align:center;font-size:16px;}
table{width:100%;border-collapse:collapse;background:#fff;table-layout:fixed;}
td,th{border:1px solid #ccc;padding:6px 4px;text-align:center;word-break:break-all;font-size:13px;}
th{background:#f5f5f5;font-size:12px;}
.total-row{background:#fafafa;font-weight:bold;}
[contenteditable]{min-height:22px;outline:none;-webkit-tap-highlight-color:transparent;}
[contenteditable]:focus{background:#fff7e6;}
.scroll-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
</style>
</head>
<body>
<h3 id="title"></h3>
<div class="scroll-wrap">
<table id="tbl">
<thead><tr><th style="width:70px">环节</th><th>包装数</th><th>内件数</th><th>复活数</th></tr></thead>
<tbody id="tb"></tbody>
<tfoot><tr class="total-row">
<td>合计</td>
<td contenteditable="true" id="tp"></td>
<td contenteditable="true" id="ti"></td>
<td contenteditable="true" id="tr">0</td>
</tr></tfoot>
</table>
</div>

<script>
/* ========== 防泄漏：包进 IIFE，刷新即释放 ========== */
(function(){

/* ========== 工具 ========== */
const rand=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
const pick=arr=>arr[rand(0,arr.length-1)];

/* ========== 生成单行数据（完全原逻辑） ========== */
function makeRow(type,isZeroNine){
  let p,b,r;
  if(type==='九宫'){
    if(isZeroNine){
      r=0; p=rand(1,3); b=rand(12,25);
    }else{
      /* 修改点1：复活数占包装数79%-92% */
      const ratioRP=rand(79,92)/100;   // 79%-92%
      b=rand(20,40);
      /* 修改点2：包装数占内件数85%-88% */
      const ratioPI=rand(85,88)/100;   // 85%-88%
      p=Math.round(b/ratioPI);         // 包装数
      r=Math.round(p*ratioRP);         // 复活数
      if(p<=b) p=b+1; if(r>p) r=p;
    }
    return {package:p,inner:b,revival:r};
  }
  if(type==='AB环')        r=rand(10,30);
  else if(type==='地分线') r=rand(5,15);
  else                     r=rand(4,12);
  /* 修改点3：非九宫同样适用新比例 */
  const ratioRP=rand(79,92)/100;   // 79%-92%
  const ratioPI=rand(85,88)/100;   // 85%-88%
  p=Math.round(r/ratioRP);         // 包装数
  b=Math.round(p/ratioPI);         // 内件数
  if(b<=r) b=r+rand(3,12); if(p<=b) p=b+rand(3,12);
  return {package:p,inner:b,revival:r};
}

/* ========== 生成数据行（完全原逻辑） ========== */
function buildRows(){
  const rows=[];
  rows.push({type:'AB环',...makeRow('AB环',false)});
  rows.push({type:'九宫',...makeRow('九宫',true)});
  const mid=rand(2,4),pool=['地分线','卸车口','九宫'];
  for(let i=0;i<mid;i++){const t=pick(pool); rows.push({type:t,...makeRow(t,false)});}
  const ab2Pos=rand(4,6);
  while(rows.length<ab2Pos) rows.push({type:pick(pool),...makeRow(pick(pool),false)});
  rows.push({type:'AB环',...makeRow('AB环',false)});
  const total=rand(11,14);
  while(rows.length<total){const t=pick(pool); rows.push({type:t,...makeRow(t,false)});}
  return rows;
}

/* ========== 环节列打散（完全原逻辑） ========== */
function shuffleCols(rows){
  const names=rows.map(r=>r.type);
  for(let i=names.length-1;i>0;i--){
    const j=rand(0,i); [names[i],names[j]]=[names[j],names[i]];
  }
  let again=true;
  while(again){
    again=false;
    for(let i=0;i<names.length-2;i++){
      if(names[i]===names[i+1] && names[i]===names[i+2]){
        for(let j=0;j<names.length;j++){
          if(j!==i && j!==i+1 && j!==i+2 && names[j]!==names[i]){
            [names[i+1],names[j]]=[names[j],names[i+1]];
            again=true; break;
          }
        }
      }
    }
  }
  rows.forEach((r,i)=>r.type=names[i]);
}

/* ========== 合计、反推（完全原逻辑） ========== */
let lock=false;
function updateSum(){
  if(lock)return; lock=true;
  let s=0;
  document.querySelectorAll('#tb tr').forEach(tr=>
    s+=parseInt(tr.cells[3].textContent)||0);
  document.getElementById('tr').textContent=s;
  lock=false;
}
function reverseAll(targetRev){
  if(lock)return; lock=true;
  const rows=[...document.querySelectorAll('#tb tr')];
  let cur=0;
  const data=rows.map(tr=>{
    const type=tr.cells[0].textContent, p=parseInt(tr.cells[1].textContent)||0,
          b=parseInt(tr.cells[2].textContent)||0, r=parseInt(tr.cells[3].textContent)||0;
    cur+=r; return {tr,type,p,b,r};
  });
  if(cur===0){lock=false;return;}
  const ratio=targetRev/cur;
  let zeroTr=null; data.forEach(o=>{if(o.type==='九宫'&&o.r===0)zeroTr=o.tr;});
  data.forEach(o=>{
    let r=Math.round(o.r*ratio), p,b;
    if(o.tr===zeroTr){ r=0; p=rand(1,3); b=rand(12,25); }
    else if(o.type==='九宫'){
      /* 修改点4：反推同样使用新比例 */
      const ratioPI=rand(85,88)/100;   // 85%-88%
      const ratioRP=rand(79,92)/100;   // 79%-92%
      b=rand(20,40); p=Math.round(b/ratioPI); r=Math.round(p*ratioRP);
      if(p<=b)p=b+1; if(r>p)r=p;
    }else{
      const ratioRP=rand(79,92)/100;   // 79%-92%
      const ratioPI=rand(85,88)/100;   // 85%-88%
      p=Math.round(r/ratioRP); b=Math.round(p/ratioPI);
      if(b<=r)b=r+rand(3,12); if(p<=b)p=b+rand(3,12);
    }
    o.tr.cells[1].textContent=p; o.tr.cells[2].textContent=b; o.tr.cells[3].textContent=r;
  });
  let now=Array.from(rows).reduce((s,tr)=>s+(parseInt(tr.cells[3].textContent)||0),0);
  let diff=targetRev-now;
  for(let o of data){if(o.tr===zeroTr)continue; if(diff>0){o.tr.cells[3].textContent=parseInt(o.tr.cells[3].textContent)+1;diff--;}else if(diff<0&&parseInt(o.tr.cells[3].textContent)>0){o.tr.cells[3].textContent=parseInt(o.tr.cells[3].textContent)-1;diff++;}if(diff===0)break;}
  lock=false;
}

/* ========== 只挂载一次事件 ========== */
let inited=false;
function initEvents(){
  if(inited)return; inited=true;
  document.getElementById('tb').addEventListener('input',e=>{
    const td=e.target;
    if(td.tagName!=='TD')return;
    const v=parseInt(td.textContent)||0;
    if(v<0)td.textContent=0;
    updateSum();
  });
  document.getElementById('tr').addEventListener('blur',e=>{
    const v=parseInt(e.target.textContent)||0;
    if(v<0){e.target.textContent=0;return;}
    reverseAll(v);
  });
}

/* ========== 渲染 ========== */
function render(){
  const rows=buildRows();
  shuffleCols(rows);
  const tb=document.getElementById('tb');
  tb.innerHTML='';
  rows.forEach(o=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${o.type}</td>
      <td contenteditable="true">${o.package}</td>
      <td contenteditable="true">${o.inner}</td>
      <td contenteditable="true">${o.revival}</td>`;
    tb.appendChild(tr);
  });
  updateSum();
}

/* ========== 入口 ========== */
function setTitle(){
  const d=new Date();
  document.getElementById('title').textContent=
    `${d.getMonth()+1}-${d.getDate()}复活件`;
}
setTitle();
initEvents();   // 只执行一次
render();

})();   /* IIFE 结束，闭包内部变量刷新即回收 */
</script>
</body>
</html>
